@model UtilizationViewModel
@using Cats.Areas.Logistics.Models
@using Kendo.Mvc.UI
@using LanguageHelpers.Localization

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_MainLayoutWide.cshtml";
}




@section Toolbar
{
     
    <a class="btn toolbar-btn " data-buttontype="btn_save" href="javascript:saveUtilization()"></a>
   
}



<fieldset>
    <legend>
        Distribution Data Entry<br/>
       <h5> Start by selecting program,Plan and zone from the left side and click on one of the requisitions.</h5>
    </legend>   
</fieldset> 

<div id="div_tree_view" class="span3">
     
        @Html.HiddenFor(m => m.RegionId)
        @using (Html.BeginForm())
        {
          
                    @Html.Label(Translator.Translate("Program"))
                    @Html.DropDownList("ProgramID", String.Empty)  
               
           
                    @Html.Label(Translator.Translate("Plan"))
                    <select id="PlanID" name="PlanID"></select>
                    
            <div id="div_month">
                @Html.Label(Translator.Translate("Month"))
                <select id="month" name="month"></select>
            </div>
            <div id="div_round">
                @Html.Label(Translator.Translate("Round"))
                <select id="round" name="round"></select>
            </div>
                   
                    
                    
        }
    @(Html.Kendo().TreeView()
        .Name("AdminUnitTreeView")
        .Animation(animation => animation.Expand(open => open.Fade(FadeDirection.In)))
        .Events(events => events
           
            .Select("onSelect")
            )
        .Items(treeview =>
        {
           
            treeview.Add().Text("Regions").Enabled(false)
                .SpriteCssClasses("folder")
                .Expanded(true)
                .Items(root =>
                {
                    foreach (var region in ViewBag.RegionCollection)
                    {
                        root.Add().Text((string)region.Name)
                            .SpriteCssClasses("folder")
                           // .Expanded(true)
                            .Items(zones =>
                            {
                                foreach( var zone in region.AdminUnit1)
                                {
                                    dynamic zone1 = zone;
                                    zones.Add().Text((string) zone.Name)
                                    .Id(zone.AdminUnitID + "")
                                        .SpriteCssClasses("image");
                                    //.Items(woredas =>
                                    //{
                                    //    foreach (var woreda in zone1.AdminUnit1)
                                    //    {
                                    //        woredas.Add().Text((string)woreda.Name)
                                    //       .Id(woreda.AdminUnitID + "")

                                    //       .SpriteCssClasses("pdf");

                                    //    }
                                    //}); 
                                }
                                
                            });
                    } 
                   
                   
                    
                });
        })
    )
</div>

<table class="borderless">
    
        <td style="width: 180px">
            <div style="float: left;">
                @(Html.Kendo().Grid<UtilizationViewModel>()
                      .Name("RequisitionGrid")
                      .Events(events => events.Change("Grid_OnRowSelect"))
                      .Selectable()
                      .Columns(columns => columns.Bound(p => p.RequisitionNo).Title(Translator.Translate("Requestion No")))
                      .Scrollable()
                      .HtmlAttributes(new { style = "height:450px;" })
                      .DataSource(dataSource => dataSource
                                                    .Ajax()
                                                    .Model(model => model.Id(p => p.RequisitionId))
                                                    .Read(read => read.Action("ReadRequestionNumbers", "Utilization", new { zoneId = -1,programId =-1,planId = -1,month=-1,round=-1}).Data("filterDataRequisitions"))
                     
                      )
                      )
            </div>
        </td>
        <td>
           <div id="tab_distribution" class="row-fluid" style="display: none; height: 570px; margin-top: 10px;margin-bottom: 10px">
                <ul class="nav nav-tabs ">
                    <li class="active">
                        <a href="#tab0" data-toggle="tab"><b>@Translator.Translate("Distribution Quantity Info")</b></a>
                    </li>

                    <li>
                        <a href="#tab1" data-toggle="tab"><b>@Translator.Translate("Distribution by Age")</b></a>
                    </li>
           
                </ul>
                 <div class="tab-content ">
            <div id="tab0" class="tab-pane active">
                <div id="BenficiaryInfo" >
                    @Html.Partial("_DistributionByBeneficiary",Model)
                </div>
            </div>
            <div id="tab1" class="tab-pane">
                <div id="DistributionByAge" >
                   @Html.Partial("_DistributionByAge",Model)
                </div>
            </div>
           
        </div>
              </div> 
        </td>
    
</table>









<script>

    $(document).ready(function(parameters) {
        $("#div_round").hide();
        $("#div_month").hide();
    });







    var selectedWoreda;
    function onSelect(e) {
       
        var id = this.dataItem(e.node).id;
        selectedWoreda = id;
      
        if (id != null) {
            var grid = $("#RequisitionGrid").data("kendoGrid");
            grid.dataSource.read();
           
        }
    }
    function filterDataRequisitions() {
       
      
        return {
            zoneId: selectedWoreda,
            programId: $("#ProgramID").val(),
            planId: $("#PlanID").val(),
            month: $("#month").val(),
            round: $("#round").val()
        };
        
    };

    function filterWithWoreda() {
        return {
            woredaID: $("#WoredaID").val(),
            woredaStockDistributionID: $("#WoredaStockDistributionID")
            
        };
        
    }


    function onRequestEnd(e) {
        //Check request type
        if (e.type == "create" || e.type == "update") {
            //check for errors in the response
            if (e.response == null || e.response.Errors == null) {
                alert("Distribution Information has been Saved!");
            }
        }
    }
    
    saveUtilization = function(e) {

        var entityGrid = $("#RequisitionGridDetail").data("kendoGrid");
        //alert(entityGrid);
        var data = entityGrid.dataSource.data();
        var totalNumber = data.length;
        
        for (var i=0;i<totalNumber;i++)
        {
            var currentDataItem = data[i];
            currentDataItem.dirty = true;
            
        }
        $("#RequisitionGridDetail").data("kendoGrid").saveChanges();
        
        $("#DistributionByAgeDetail").data("kendoGrid").saveChanges();
       
    };
    
    var selectedRequisitionId;
    Grid_OnRowSelect = function (e) {

        var distributionTab = $("#tab_distribution");
        distributionTab.show();
        //Selecting Grid
        var gview = $("#RequisitionGrid").data("kendoGrid");
        //Getting selected item
        var selectedItem = gview.dataItem(gview.select());
        //accessing selected rows data 
        selectedRequisitionId = selectedItem.RequisitionId;
        var grid = $("#RequisitionGridDetail").data("kendoGrid");
        grid.dataSource.read();
        var grid2 = $("#DistributionByAgeDetail").data("kendoGrid");
        grid2.dataSource.read();
       
       
        
    };


    function filterDataRequisitionsDetail() {
        
        return { requisitionId: selectedRequisitionId};
        
       
    }

    $("#WoredaID").change(function() {
        alert("here");
        var grid = $("#RequisitionGridDetail").data("kendoGrid");
        grid.dataSource.read();
    });
    $("#ProgramID").change(function () {
        
        var grid = $("#RequisitionGrid").data("kendoGrid");
        grid.dataSource.read();
    });

    $("#round").change(function() {
        var grid = $("#RequisitionGrid").data("kendoGrid");
        grid.dataSource.read();
    });

    $("#month").change(function() {
        var grid = $("#RequisitionGrid").data("kendoGrid");
        grid.dataSource.read();
    });
    $("#PlanID").change(function () {
           
        if ($("#ProgramID").val() == 1)//releif
        {
           
           
            $.getJSON('/Utilization/GetMonth/' + $("#PlanID").val(), function (data) {
                var months = '<option> Select Month </option>';
                $.each(data, function (i, m) {
                    months += "<option value='" + m.Value + "'>" + m.Text + "</option>";
                });
                $("#month").html(months);
            });

            $.getJSON('/Utilization/GetRound/' + $("#PlanID").val(), function (data) {
                var months = '<option> Select Round </option>';
                $.each(data, function (i, r) {
                    months += "<option value='" + r.Value + "'>" + r.Text + "</option>";
                });
                $("#round").html(months);
            });
            
            $("#div_month").show();
            $("#div_round").show();
        }
        else if ($("#ProgramID").val())//psnp
        {
            $("#div_month").hide();

            $.getJSON('/Utilization/GetRound/' + $("#PlanID").val(), function (data) {
                var months = '<option> Select Round </option>';
                $.each(data, function (i, r) {
                    months += "<option value='" + r.Value + "'>" + r.Text + "</option>";
                });
                $("#round").html(months);
            });

            $("#div_round").show();
        }
        

        var grid = $("#RequisitionGrid").data("kendoGrid");
        grid.dataSource.read();
    });
    $(function () {
        
      
        
        $("#ProgramID").change(function() {
               
            $("#div_round").hide();
            $("#div_month").hide();
            
            $.getJSON('/Utilization/GetPlans/' + $("#ProgramID").val(), function (data) {
                var plans = '<option> Select a Plan </option>';
                $.each(data, function (i, plan) {
                    plans += "<option value='" + plan.Value +"'>" + plan.Text + "</option>";
                });
                $("#PlanID").html(plans);
            });


           
        });
    });       
   
</script>